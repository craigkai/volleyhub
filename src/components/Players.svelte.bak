<script lang="ts">
	import { isHttpError, type HttpError } from '@sveltejs/kit';
	import { onMount } from 'svelte';
	import * as Table from '$components/ui/table';
	import { Input } from '$components/ui/input/index.js';
	import { Button } from '$components/ui/button';
	import * as Select from '$components/ui/select/index.js';
	import toast from 'svelte-5-french-toast';
	import type { Team } from '$lib/team.svelte';
	import UserIcon from 'lucide-svelte/icons/user';
	import PlusIcon from 'lucide-svelte/icons/plus';
	import TrashIcon from 'lucide-svelte/icons/trash-2';
	import EditIcon from 'lucide-svelte/icons/edit-2';
	import SaveIcon from 'lucide-svelte/icons/check';
	import UsersIcon from 'lucide-svelte/icons/users';
	import RefreshCw from 'lucide-svelte/icons/refresh-cw';

	const {
		teams = $bindable(),
		tournament
	} = $props();

	let newPlayerName = $state('');
	let editingTeamId = $state<string | number | null>(null);

	// Use derived state that properly tracks changes
	// For individual format, teams are 1-person "players"
	let currentPlayers = $derived(teams?.teams?.filter((t: Team) => t.team_size === 1) ?? []);

	// Loading states for better UX
	let isCreating = $state(false);
	let deletingTeamId = $state<number | null>(null);
	let updatingTeamId = $state<number | null>(null);

	async function createPlayer() {
		if (!newPlayerName.trim()) {
			toast.error('Player name cannot be empty');
			return;
		}

		if (teams.teams.findIndex((t: { name: string }) => t.name === newPlayerName) !== -1) {
			toast.error('Player already exists');
			return;
		}

		isCreating = true;
		try {
			// Create a 1-person team (which represents a player in individual format)
			const newTeam = {
				name: newPlayerName,
				event_id: tournament.id,
				state: 'active',
				team_size: 1  // This marks it as an individual "player"
			};

			const newTeamInstance = await teams.create(newTeam);
			if (newTeamInstance) {
				teams.teams = [...teams.teams, newTeamInstance];
			}

			toast.success(`Player ${newPlayerName} added`);
			newPlayerName = '';
		} catch (err) {
			if (isHttpError(err)) {
				toast.error(err.body.message);
			} else {
				toast.error('Failed to add player. Please try again.');
			}
		} finally {
			isCreating = false;
		}
	}

	async function deletePlayer(team: Team) {
		deletingTeamId = team.id ?? null;
		try {
			await team.delete(team);
			teams.teams = teams.teams.filter(
				(t: { id: number | undefined }) => t.id !== team.id
			);

			toast.success(`Player ${team.name} removed`);
		} catch (err: any) {
			toast.error(err?.body?.message ?? 'Failed to delete player. Please try again.');
		} finally {
			deletingTeamId = null;
		}
	}

	async function updatePlayer(team: Team) {
		if (!team.name.trim()) {
			toast.error('Player name cannot be empty');
			return;
		}

		updatingTeamId = team.id ?? null;
		try {
			const res = await team.update(team);
			if (res) {
				toast.success(`Player ${team.name} updated`);
				editingTeamId = null;
			}
		} catch (err: any) {
			toast.error('Failed to update player. Please try again.');
		} finally {
			updatingTeamId = null;
		}
	}

	// Load teams when component mounts
	onMount(async () => {
		if (tournament?.id && teams?.load) {
			try {
				// Only load if not already loaded
				if (!teams.teams || teams.teams.length === 0) {
					await teams.load(tournament.id);
				}
			} catch (err) {
				console.error('Error loading teams:', err);
			}
		}
	});
</script>

<!-- Simplified player management for mix-and-match tournaments -->
<div class="mx-auto max-w-5xl space-y-6 p-4">
	<!-- Player Management Section -->
	<div
		class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-lg dark:border-slate-700 dark:bg-slate-800"
	>
		<div
			class="border-b border-slate-200 bg-slate-50 px-6 py-4 dark:border-slate-700 dark:bg-slate-900"
		>
			<div class="flex items-center gap-3">
				<div
					class="flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br from-slate-700 to-slate-900 shadow-md"
				>
					<UsersIcon class="h-5 w-5 text-white" />
				</div>
				<div>
					<h2 class="text-lg font-bold text-slate-900 dark:text-white">Player Roster</h2>
					<p class="text-sm text-slate-600 dark:text-slate-400">Manage tournament participants</p>
				</div>
			</div>
		</div>

		<div class="p-6">
			<!-- Add Player Form -->
			<div class="mb-6 flex flex-col gap-3 sm:flex-row">
				<Input
					type="text"
					id="newPlayer"
					class="h-11 flex-1 rounded-xl border-slate-300 bg-white text-sm shadow-sm transition-all placeholder:text-slate-400 hover:border-slate-400 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 dark:border-slate-600 dark:bg-slate-900 dark:text-slate-100 dark:placeholder:text-slate-500 dark:hover:border-slate-500"
					placeholder="Enter player name..."
					onkeydown={(e) => {
						if (e?.key === 'Enter') {
							createPlayer();
						} else if (e?.key === 'Escape') {
							newPlayerName = '';
							if (e.target) (e.target as HTMLElement).blur();
						}
					}}
					bind:value={newPlayerName}
				/>


				<Button
					onclick={createPlayer}
					class="inline-flex h-11 items-center gap-2 rounded-xl bg-slate-900 px-5 text-sm font-bold text-white shadow-md transition-all hover:bg-slate-800 hover:shadow-lg focus:ring-4 focus:ring-slate-500/30 focus:outline-none dark:bg-slate-700 dark:hover:bg-slate-600"
				>
					<PlusIcon class="h-4 w-4" />
					<span>Add Player</span>
				</Button>
			</div>

			<!-- Player List -->
			{#if currentPlayers.length === 0}
				<div
					class="flex flex-col items-center justify-center rounded-xl border-2 border-dashed border-slate-300 bg-slate-50 py-12 text-center dark:border-slate-600 dark:bg-slate-900/50"
				>
					<div
						class="mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-slate-200 dark:bg-slate-700"
					>
						<UserIcon class="h-8 w-8 text-slate-400 dark:text-slate-500" />
					</div>
					<h3 class="mb-2 text-base font-bold text-slate-700 dark:text-slate-300">
						No players yet
					</h3>
					<p class="text-sm text-slate-500 dark:text-slate-400">
						Add your first player to get started
					</p>
				</div>
			{:else}
				<div
					class="overflow-hidden rounded-xl border border-slate-200 shadow-sm dark:border-slate-700"
				>
					<Table.Root class="w-full">
						<Table.Header>
							<Table.Row
								class="border-b border-slate-200 bg-slate-100 dark:border-slate-700 dark:bg-slate-900"
							>
								<Table.Head
									class="py-3.5 text-left text-xs font-bold tracking-wide text-slate-700 uppercase dark:text-slate-300"
								>
									Player Name
								</Table.Head>
								<Table.Head
									class="w-28 py-3.5 text-right text-xs font-bold tracking-wide text-slate-700 uppercase dark:text-slate-300"
								>
									Actions
								</Table.Head>
							</Table.Row>
						</Table.Header>
						<Table.Body>
							{#each currentPlayers as player (player.id)}
								<Table.Row
									class="border-b border-slate-100 transition-colors hover:bg-slate-50 dark:border-slate-700 dark:hover:bg-slate-800/50"
								>
									<Table.Cell class="py-4">
										{#if editingTeamId === player.id}
											<div class="flex items-center gap-2">
												<Input
													class="h-9 rounded-lg border-slate-300 bg-white text-sm shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500/20 dark:border-slate-600 dark:bg-slate-900 dark:text-slate-100"
													type="text"
													bind:value={player.name}
													onkeydown={(e) => {
														if (e?.key === 'Enter') {
															updatePlayer(player);
														} else if (e?.key === 'Escape') {
															editingTeamId = null;
															if (e.target) (e.target as HTMLElement).blur();
															toast.success('Edit canceled');
														}
													}}
												/>
												<Button
													onclick={() => updatePlayer(player)}
													class="inline-flex h-9 w-9 items-center justify-center rounded-lg border border-slate-300 bg-white p-0 text-slate-700 shadow-sm transition-all hover:bg-slate-50 focus:ring-2 focus:ring-indigo-500/20 focus:outline-none dark:border-slate-600 dark:bg-slate-800 dark:text-slate-200 dark:hover:bg-slate-700"
													title="Save"
												>
													<SaveIcon class="h-4 w-4" />
												</Button>
											</div>
										{:else}
											<span class="text-sm font-semibold text-slate-900 dark:text-slate-100">
												{player.name}
											</span>
										{/if}
									</Table.Cell>

									{#if isKingQueen}
										<Table.Cell class="py-4">
											<span
												class="inline-flex items-center gap-1.5 rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700 dark:bg-slate-700 dark:text-slate-300"
											>
												{player.gender === 'male' ? '♂ Male' : '♀ Female'}
											</span>
										</Table.Cell>
									{/if}

									<Table.Cell class="py-4 text-right">
										<div class="inline-flex gap-1.5">
											{#if editingTeamId !== player.id}
												<Button
													onclick={() => (editingTeamId = player.id)}
													class="inline-flex h-9 w-9 items-center justify-center rounded-lg border border-slate-300 bg-white p-0 text-slate-600 shadow-sm transition-all hover:bg-slate-50 hover:text-slate-900 focus:ring-2 focus:ring-slate-500/20 focus:outline-none dark:border-slate-600 dark:bg-slate-800 dark:text-slate-400 dark:hover:bg-slate-700 dark:hover:text-slate-200"
													title="Edit player"
												>
													<EditIcon class="h-4 w-4" />
												</Button>
											{/if}
											<Button
												onclick={() => deletePlayer(player)}
												class="inline-flex h-9 w-9 items-center justify-center rounded-lg border border-red-300 bg-white p-0 text-red-600 shadow-sm transition-all hover:bg-red-50 hover:text-red-700 focus:ring-2 focus:ring-red-500/20 focus:outline-none dark:border-red-800 dark:bg-slate-800 dark:text-red-400 dark:hover:bg-red-900/20 dark:hover:text-red-300"
												title="Delete player"
											>
												<TrashIcon class="h-4 w-4" />
											</Button>
										</div>
									</Table.Cell>
								</Table.Row>
							{/each}
						</Table.Body>
					</Table.Root>
				</div>

				<!-- Player Stats Footer -->
				<div
					class="mt-4 flex items-center justify-between rounded-lg bg-slate-50 px-4 py-3 dark:bg-slate-900/50"
				>
					<div class="flex items-center gap-2">
						<div
							class="flex h-8 w-8 items-center justify-center rounded-lg bg-slate-200 dark:bg-slate-700"
						>
							<UsersIcon class="h-4 w-4 text-slate-600 dark:text-slate-400" />
						</div>
						<span class="text-sm font-semibold text-slate-700 dark:text-slate-300">
							{currentPlayers.length} player{currentPlayers.length !== 1 ? 's' : ''} total
						</span>
					</div>
				</div>
			{/if}
		</div>
	</div>
</div>
